<script lang="ts" setup>
import { computed, onMounted, ref } from "vue";
import { useUi } from "@/uni_modules/cool-ui";
import { getEasemobServerConversations, type EasemobConversationItem } from "@/utils/easemob";

const ui = useUi();

const loading = ref(false);
const conversations = ref<EasemobConversationItem[]>([]);
const cursor = ref<string>("");

const hasMore = computed(() => !!cursor.value);

const emit = defineEmits<{
	(e: "select", item: EasemobConversationItem): void;
}>();

const PAGE_SIZE = 20;

const loadConversations = async (reset: boolean) => {
	if (loading.value) return;

	loading.value = true;
	try {
		if (reset) {
			cursor.value = "";
			conversations.value = [];
		}

		const res = await getEasemobServerConversations({
			pageSize: PAGE_SIZE,
			cursor: cursor.value,
			includeEmptyConversations: false
		});

		const list = (res?.conversations ?? []) as EasemobConversationItem[];
		if (reset) {
			conversations.value = list;
		} else {
			conversations.value = conversations.value.concat(list);
		}

		cursor.value = res?.cursor ?? "";
	} catch (err) {
		console.error("[IM] 获取会话列表失败", err);
		ui.showToast({ message: "获取会话列表失败" });
	} finally {
		loading.value = false;
	}
};

onMounted(() => {
	loadConversations(true);
});

const handleRefresh = () => {
	loadConversations(true);
};

const handleLoadMore = () => {
	if (!hasMore.value) {
		ui.showToast({ message: "没有更多会话了" });
		return;
	}
	loadConversations(false);
};

const getTitle = (item: EasemobConversationItem) => {
	return item.conversationId || "未知会话";
};

const getLastMessagePreview = (item: EasemobConversationItem) => {
	const m = (item as any).lastMessage;
	if (!m) return "";
	return m.msg || (m.body && m.body.msg) || "";
};

const getTimeLabel = (item: EasemobConversationItem) => {
	const m = (item as any).lastMessage;
	const t = m?.time || m?.serverTime;
	if (!t) return "";
	try {
		const d = new Date(t);
		const h = String(d.getHours()).padStart(2, "0");
		const m2 = String(d.getMinutes()).padStart(2, "0");
		return `${h}:${m2}`;
	} catch {
		return "";
	}
};

const handleClickItem = (item: EasemobConversationItem) => {
	emit("select", item);
};
</script>

<template>
	<view class="easeim-history-root">
		<view class="flex flex-row items-center mb-2">
			<view class="flex-1 text-sm text-gray-700">最近对话</view>
			<cl-button @click="handleRefresh" :loading="loading"> 刷新 </cl-button>
		</view>

		<scroll-view scroll-y class="easeim-history-scroll">
			<view
				v-if="!conversations.length && !loading"
				class="py-4 text-center text-xs text-gray-400"
			>
				暂无会话
			</view>

			<view
				v-for="item in conversations"
				:key="item.conversationId"
				class="easeim-history-item"
				@tap="handleClickItem(item)"
			>
				<view class="flex flex-row items-center justify-between">
					<view class="flex flex-row items-center" style="gap: 8rpx">
						<view class="easeim-avatar">
							<text class="easeim-avatar-text">{{ getTitle(item).slice(0, 1) }}</text>
						</view>
						<view>
							<view class="text-sm text-gray-900 mb-1">{{ getTitle(item) }}</view>
							<view class="text-xs text-gray-500">
								{{ getLastMessagePreview(item) || " " }}
							</view>
						</view>
					</view>
					<view class="flex flex-col items-end">
						<view class="text-[10px] text-gray-400 mb-1">{{ getTimeLabel(item) }}</view>
						<view
							v-if="item.unReadCount && item.unReadCount > 0"
							class="easeim-unread-badge"
						>
							<text class="easeim-unread-text">
								{{ item.unReadCount > 99 ? "99+" : item.unReadCount }}
							</text>
						</view>
					</view>
				</view>
				<view
					v-if="hasMore"
					class="py-3 text-center text-xs text-blue-500"
					@tap="handleLoadMore"
				>
					加载更多会话
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<style lang="scss" scoped>
.easeim-history-root {
	@apply flex flex-col h-full;
}

.easeim-history-scroll {
	@apply flex-1 border rounded px-2 py-1 bg-white;
}

.easeim-history-item {
	@apply py-2 border-b last:border-b-0;
}

.easeim-avatar {
	@apply w-[40px] h-[40px] rounded-full bg-gray-200 flex items-center justify-center;
}

.easeim-avatar-text {
	@apply text-base text-gray-700;
}

.easeim-unread-badge {
	@apply min-w-[24px] h-[24px] px-1 rounded-full bg-red-500 flex items-center justify-center;
}

.easeim-unread-text {
	@apply text-[10px] text-white;
}
</style>
