<script lang="ts" setup>
import { ref } from "vue";
import { useUi } from "@/uni_modules/cool-ui";

import AppPage from "@/components/common/layout/app-page.uvue";
import {
	initEasemob,
	addEasemobEventHandlers,
	loginEasemob,
	logoutEasemob,
	sendEasemobTextMessage
} from "@/utils/easemob";

const ui = useUi();

// 请将此处替换为你自己的环信 AppKey，例如 "yourOrg#yourApp"
const IM_APP_KEY = "<your-appkey>";

const imUserId = ref("");
const imPassword = ref("");
const imPeerId = ref("");
const imInputText = ref("");

const isIMInited = ref(false);
const isConnecting = ref(false);
const isConnected = ref(false);

const messages = ref<
	{
		id: string;
		from: string;
		to: string;
		text: string;
		direction: "in" | "out";
		time: number;
	}[]
>([]);

const ensureIMInited = () => {
	if (isIMInited.value) return;

	initEasemob({
		appKey: IM_APP_KEY,
		url: "wss://im-api-wechat.easemob.com/websocket",
		apiUrl: "https://a1.easemob.com"
	});

	addEasemobEventHandlers({
		onOpened: () => {
			isConnected.value = true;
			ui.showToast({ message: "IM 已连接" });
		},
		onClosed: () => {
			isConnected.value = false;
		},
		onTextMessage: (msg: any) => {
			const text = msg?.msg || msg?.data || "";
			messages.value.push({
				id: msg.id || String(Date.now()),
				from: msg.from,
				to: msg.to,
				text,
				direction: "in",
				time: Date.now()
			});
		},
		onError: (err: any) => {
			console.error("[IM] error", err);
		}
	});

	isIMInited.value = true;
};

const handleLogin = async () => {
	if (!imUserId.value || !imPassword.value) {
		ui.showToast({ message: "请输入 IM 用户名和密码" });
		return;
	}

	try {
		ensureIMInited();
		isConnecting.value = true;
		await loginEasemob({
			user: imUserId.value,
			pwd: imPassword.value
		} as any);
	} catch (err: any) {
		console.error("[IM] 登录失败", err);
		ui.showToast({ message: "IM 登录失败" });
	} finally {
		isConnecting.value = false;
	}
};

const handleLogout = () => {
	logoutEasemob();
	isConnected.value = false;
};

const handleSend = async () => {
	const content = imInputText.value.trim();
	if (!content) return;
	if (!isConnected.value) {
		ui.showToast({ message: "请先登录 IM" });
		return;
	}
	if (!imPeerId.value) {
		ui.showToast({ message: "请输入对端用户 ID" });
		return;
	}

	try {
		await sendEasemobTextMessage({
			to: imPeerId.value,
			chatType: "singleChat",
			msg: content
		});

		messages.value.push({
			id: `out_${Date.now()}`,
			from: imUserId.value,
			to: imPeerId.value,
			text: content,
			direction: "out",
			time: Date.now()
		});
		imInputText.value = "";
	} catch (err: any) {
		console.error("[IM] 发送失败", err);
		ui.showToast({ message: "消息发送失败" });
	}
};
</script>

<template>
	<app-page title="IM 文本聊天测试" :back-top="false">
		<template #content>
			<view class="p-3 my-3">
				<view class="text-xs text-gray-500">
					IM 状态：{{ isConnected ? "已连接" : "未连接" }}
				</view>

				<view class="flex flex-col gap-2">
					<view class="flex gap-2">
						<input
							v-model="imUserId"
							placeholder="IM 用户名"
							class="flex-1 px-2 py-1 border rounded text-sm"
						/>
						<input
							v-model="imPassword"
							placeholder="密码 / Token"
							password
							class="flex-1 px-2 py-1 border rounded text-sm"
						/>
					</view>
					<view class="flex gap-2">
						<button
							class="px-3 py-1 bg-blue-500 text-white text-xs rounded"
							@click="handleLogin"
							:disabled="isConnecting"
						>
							{{ isConnecting ? "登录中..." : "登录 IM" }}
						</button>
						<button class="px-3 py-1 bg-gray-200 text-xs rounded" @click="handleLogout">
							退出
						</button>
					</view>
				</view>

				<view class="flex flex-col gap-2 mt-2">
					<input
						v-model="imPeerId"
						placeholder="对端用户 ID"
						class="w-full px-2 py-1 border rounded text-sm"
					/>
					<view class="flex gap-2">
						<input
							v-model="imInputText"
							placeholder="输入要发送的文本消息"
							class="flex-1 px-2 py-1 border rounded text-sm"
						/>
						<button
							class="px-3 py-1 bg-green-500 text-white text-xs rounded"
							@click="handleSend"
						>
							发送
						</button>
					</view>
				</view>

				<scroll-view scroll-y class="mt-3 h-[320px] border rounded p-2 bg-white">
					<view v-for="m in messages" :key="m.id" class="mb-2 text-sm">
						<view class="text-gray-500 text-[10px] mb-1">
							{{ m.direction === "out" ? "我 → " + m.to : m.from + " → 我" }}
						</view>
						<view
							:class="[
								'inline-block px-2 py-1 rounded',
								m.direction === 'out'
									? 'bg-blue-500 text-white self-end'
									: 'bg-gray-100 text-gray-900'
							]"
						>
							{{ m.text }}
						</view>
					</view>
				</scroll-view>
			</view>
		</template>
	</app-page>
</template>

<style lang="scss" scoped></style>
