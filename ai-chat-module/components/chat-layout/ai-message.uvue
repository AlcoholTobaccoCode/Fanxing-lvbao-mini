<!--
@description: AI æ¶ˆæ¯å®¹å™¨ç»„ä»¶
-->
<script lang="ts" setup>
import { computed } from "vue";
// import ZeroMarkdownView from "../zero-markdown-view/components/zero-markdown-view/zero-markdown-view.vue";
import LawMarkdownView from "../zero-markdown-view/components/law-markdown-view/law-markdown-view.vue";

interface Props {
	content?: string;
	// æ·±åº¦æ€è€ƒç›¸å…³
	deepThink?: string;
	deepThinkStartTime?: number;
	deepThinkEndTime?: number;
	deepThinkExpanded?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
	deepThinkExpanded: true
});

const emit = defineEmits<{
	(e: "toggle-deep-think"): void;
	(e: "ref-tap", data: { type: string; text: string; json: Record<string, any> | null }): void;
}>();

// è®¡ç®—æ€è€ƒç”¨æ—¶æ–‡æ¡ˆ
const deepThinkTimeText = computed(() => {
	if (!props.deepThink) return "";

	if (props.deepThinkEndTime && props.deepThinkStartTime) {
		const seconds = Math.round((props.deepThinkEndTime - props.deepThinkStartTime) / 1000);
		return `æ€è€ƒï¼ˆç”¨æ—¶ ${seconds} ç§’ï¼‰`;
	}

	return "æ€è€ƒä¸­...";
});

const handleToggle = () => {
	emit("toggle-deep-think");
};

// æ³•å¾‹å¼•ç”¨ç‚¹å‡» - é€ä¼ ç»™å¤–éƒ¨å¤„ç†
const handleRefTap = (e: { type: string; text: string; json: Record<string, any> | null }) => {
	emit("ref-tap", e);
};
</script>

<template>
	<view class="ai-message px-4 my-2">
		<!-- æ·±åº¦æ€è€ƒå±•ç¤º -->
		<view v-if="deepThink" class="deepthink-wrapper">
			<view class="deepthink-header" @tap.stop="handleToggle">
				<view class="deepthink-icon">
					<cl-text>ğŸ’­</cl-text>
				</view>
				<text class="deepthink-title">{{ deepThinkTimeText }}</text>
				<text class="deepthink-toggle">
					<cl-icon :name="`arrow-${deepThinkExpanded ? 'up-s-line' : 'down-s-line'}`" />
				</text>
			</view>
			<view v-if="deepThinkExpanded" class="deepthink-body">
				<text class="deepthink-text">{{ deepThink }}</text>
			</view>
		</view>

		<!-- å‰ç½®æ’æ§½ï¼ˆé˜¶æ®µè¿›åº¦ç­‰ï¼‰ -->
		<slot name="prepend"></slot>

		<!-- Markdown å†…å®¹ -->
		<template v-if="content">
			<!-- <zero-markdown-view :markdown="content" :aiMode="true" /> -->
			<law-markdown-view :markdown="content" @ref-tap="handleRefTap" />
		</template>

		<!-- é¢å¤–å†…å®¹æ’æ§½ï¼ˆå¼•ç”¨ã€æ¨èç­‰ï¼‰ -->
		<slot></slot>

		<!-- åç½®æ’æ§½ï¼ˆå¯¼å‡ºæ ç­‰ï¼‰ -->
		<slot name="append"></slot>
	</view>
</template>

<style lang="scss" scoped>
.ai-message {
	@apply w-full box-border;
}

.deepthink-wrapper {
	@apply mt-3 mb-1;
}

.deepthink-header {
	@apply flex flex-row items-center mb-1;
}

.deepthink-icon {
	border-radius: 999px;
	margin-right: 6px;
}

.deepthink-title {
	@apply text-sm mr-1;
	color: #3b82f6;
}

.deepthink-toggle {
	@apply text-sm;
	color: #9ca3af;
}

.deepthink-body {
	@apply mt-1 pl-3 border-l;
	border-color: #e5e7eb;
}

.deepthink-text {
	@apply text-sm leading-relaxed;
	color: #6b7280;
}
</style>
