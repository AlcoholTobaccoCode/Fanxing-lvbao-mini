<script lang="ts" setup>
import { computed, nextTick, ref, watch } from "vue";
import { useUi } from "@/uni_modules/cool-ui";
import { Logger } from "@/cool/utils/log";
import { useStore } from "@/cool";
import type { SendData, Tools } from "@/cool/types/chat-input";
import type { RecommendLawyerItem } from "@/api/consult";
import { createConsultTtsController } from "@/utils/aliyun/tts-stream";
import { showLoginModal } from "@/cool/store/login-modal";
import { chatFlowStore, consultSessionStore, chatInputStore } from "@/cool/store";

import AppPage from "@/components/common/layout/app-page.uvue";
import ChatInput from "@/ai-chat-module/components/chat-input/ai-chat/index.uvue";
import AudioBubble from "@/ai-chat-module/components/chat-input/audio-bubble.uvue";
import ZeroMarkdownView from "../components/zero-markdown-view/components/zero-markdown-view/zero-markdown-view.vue";
import LawyerList from "../components/lawyer-recommend/lawyer-list.uvue";

const log = new Logger("ConsultChatPage");
const ui = useUi();
const { user } = useStore();

// å¯¹è¯è¾“å…¥å†…å®¹
const inputValue = ref("");

// è·å–å½“å‰ sessionId
const sessionId = computed(() => consultSessionStore.sessionId.value || "");

// æ¶ˆæ¯åˆ—è¡¨
const messages = consultSessionStore.messages;
// æ˜¯å¦æ­£åœ¨ç”Ÿæˆ AI å›å¤
const isGenerating = computed(() => consultSessionStore.loading.value);
// æ¨èå¾‹å¸ˆåŠ è½½ä¸­
const isRecommendLoading = computed(() => consultSessionStore.recommendLoading.value);

// å½“å‰æµå¼é˜¶æ®µçŠ¶æ€æ–‡æ¡ˆï¼ˆä¾‹å¦‚ï¼šæ­£åœ¨æ€è€ƒä¸­ / æ­£åœ¨ä¸ºæ‚¨æ£€ç´¢ç›¸å…³å¸æ³•åˆ¤ä¾‹...ï¼‰
const streamStatus = computed(() => consultSessionStore.streamStatus.value);

// æ·±åº¦æ€è€ƒå±•å¼€çŠ¶æ€ï¼šæŒ‰æ¶ˆæ¯ç´¢å¼•è®°å½•â€œæ”¶èµ·â€çš„æ¡ç›®ï¼ˆé»˜è®¤å…¨éƒ¨å±•å¼€ï¼‰
const collapsedDeepThinkIndexes = ref<number[]>([]);

//#region æ·±åº¦æ€è€ƒ
// æŒ‡å®š ai å›å¤çš„æ·±åº¦æ€è€ƒæ˜¯å¦å±•å¼€
const isDeepThinkExpanded = (idx: number) => {
	// ä¸åœ¨æ”¶èµ·åˆ—è¡¨ä¸­å³è§†ä¸ºå±•å¼€
	return !collapsedDeepThinkIndexes.value.includes(idx);
};

const toggleDeepThink = (idx: number) => {
	const arr = collapsedDeepThinkIndexes.value.slice();
	const i = arr.indexOf(idx);
	if (i >= 0) {
		// å·²æ”¶èµ· -> ä»åˆ—è¡¨ç§»é™¤ï¼Œæ¢å¤å±•å¼€
		arr.splice(i, 1);
	} else {
		// å½“å‰å±•å¼€ -> åŠ å…¥æ”¶èµ·åˆ—è¡¨
		arr.push(idx);
	}
	collapsedDeepThinkIndexes.value = arr;
};

// è®¡ç®—æ€è€ƒç”¨æ—¶
const getDeepThinkTimeText = (msg: any) => {
	if (!msg.deepThink) return "";

	// å¦‚æœæœ‰ç»“æŸæ—¶é—´ï¼Œæ˜¾ç¤ºç”¨æ—¶
	if (msg.deepThinkEndTime && msg.deepThinkStartTime) {
		const seconds = Math.round((msg.deepThinkEndTime - msg.deepThinkStartTime) / 1000);
		return `æ€è€ƒï¼ˆç”¨æ—¶ ${seconds} ç§’ï¼‰`;
	}

	// å¦åˆ™æ˜¾ç¤ºæ€è€ƒä¸­
	return "æ€è€ƒä¸­...";
};
//#endregion

//#region èŠå¤©åˆ—è¡¨è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶
const scrollIntoViewId = ref("chat-bottom-a");
const autoScroll = ref(true);
const lastScrollTop = ref(0);

const scrollToBottom = () => {
	if (!autoScroll.value) return;
	nextTick(() => {
		// åœ¨ä¸¤ä¸ªé”šç‚¹ä¹‹é—´åˆ‡æ¢ï¼Œç¡®ä¿ scroll-into-view æ¯æ¬¡éƒ½å˜åŒ–ï¼Œå¼ºåˆ¶è§¦å‘æ»šåŠ¨
		scrollIntoViewId.value =
			scrollIntoViewId.value === "chat-bottom-a" ? "chat-bottom-b" : "chat-bottom-a";
	});
};

// é¡¶éƒ¨å·¥å…·å˜åŒ– & è¾“å…¥æ¨¡å¼å˜åŒ–ï¼šåŒæ­¥åˆ°å…¨å±€ chatInputStoreï¼Œä¿è¯é¦–é¡µä¸è¯¦æƒ…é¡µä¸€è‡´
const handleToolsChange = (val: Tools) => {
	chatInputStore.tools.value = val;
};

const handleInputModeChange = (mode: string) => {
	chatInputStore.inputMode.value = mode as any;
};

// ç›‘å¬æ¶ˆæ¯å˜åŒ–ï¼šé»˜è®¤ä¿æŒè·Ÿéšåˆ°åº•éƒ¨ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨ä¸Šæ»‘
watch(
	messages,
	() => {
		if (!autoScroll.value) return;
		scrollToBottom();
	},
	{ deep: true }
);

// ç”¨æˆ·æ»šåŠ¨èŠå¤©åˆ—è¡¨ï¼šä¸€æ—¦æœ‰å‘ä¸Šæ»šåŠ¨ï¼Œå°±å…³é—­è‡ªåŠ¨æ»šåŠ¨å¹¶å–æ¶ˆé”šç‚¹
const handleScroll = (e: any) => {
	const top = e?.detail?.scrollTop ?? 0;
	log.debug("ç”¨æˆ·æ»‘åŠ¨ top ===> ", top);
	if (top < lastScrollTop.value) {
		autoScroll.value = false;
		// æ¸…ç©º scroll-into-viewï¼Œé¿å…ç»§ç»­è¢«å¼ºåˆ¶æ‹‰åˆ°åº•éƒ¨
		scrollIntoViewId.value = "";
	}
	lastScrollTop.value = top;
};

// ç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨
const handleScrollToLower = () => {
	// åªæœ‰åœ¨ AI ä»åœ¨ç”Ÿæˆæ—¶ï¼Œé‡æ–°å¼€å¯è‡ªåŠ¨æ»šåŠ¨
	if (isGenerating.value) {
		autoScroll.value = true;
		scrollToBottom();
	}
};

//#endregion

//#region æ¨èå¾‹å¸ˆç›¸å…³

// ç‚¹å‡»å¾‹å¸ˆå¡ç‰‡ - è·³è½¬åˆ°å¾‹å¸ˆè¯¦æƒ…é¡µ
const handleLawyerClick = (lawyer: RecommendLawyerItem) => {
	log.debug("ç‚¹å‡»å¾‹å¸ˆå¡ç‰‡", lawyer);
	uni.navigateTo({
		url: `/pages/lawyer/detail?id=${lawyer.user_id}`
	});
};

// ç‚¹å‡»æ›´å¤š - è·³è½¬åˆ°æ›´å¤šå¾‹å¸ˆåˆ—è¡¨é¡µ
const handleMoreLawyers = () => {
	log.debug("ç‚¹å‡»æ›´å¤šå¾‹å¸ˆ");
	uni.navigateTo({
		url: `/ai-chat-module/consult/lawyer-list?sessionId=${sessionId.value}`
	});
};

//#endregion

const hasValidLaunch = computed(() => {
	const launch = chatFlowStore.launchPayload.value;
	const cfg = chatFlowStore.currentConfig.value;
	return !!launch && !!cfg && launch.moduleKey === "consult";
});

onLoad(() => {
	const launch = chatFlowStore.launchPayload.value;
	const cfg = chatFlowStore.currentConfig.value;

	log.debug("[consult/chat] onLoad launch =>", launch, "cfg =>", cfg);

	if (!launch || !cfg || launch.moduleKey !== "consult") {
		log.warn("[consult/chat] æ— æœ‰æ•ˆå¯åŠ¨å‚æ•°ï¼Œåœç•™åœ¨ç©ºçŠ¶æ€");
		return;
	}

	// åˆå§‹åŒ–æœ¬æ¬¡å’¨è¯¢ä¼šè¯
	consultSessionStore.initFromLaunch(launch);

	// æŒ‰æ¨¡å—é…ç½®åŒæ­¥è¾“å…¥ç»„ä»¶é…ç½®
	chatInputStore.setConfig({
		tools: launch.tools,
		inputMode: launch.inputMode,
		placeholder: cfg.placeholder,
		showDefaultDeepThink: cfg.enableDeepThink,
		showDefaultKnowledge: cfg.enableKnowledge,
		showDefaultNetwork: cfg.enableNetwork
	});

	// è‡ªåŠ¨ä»¥é¦–é¡µé¦–é—®å‘èµ·ä¸€æ¬¡æµå¼å’¨è¯¢
	if (launch.text) {
		consultSessionStore.sendTextQuestion(launch.text, launch.tools, undefined, {
			fromVoice: !!launch.voice,
			voiceUrl: launch.voice?.onlineUrl,
			voiceLength: launch.voice ? Math.ceil((launch.voice.duration || 0) / 1000) : undefined
		});
	}

	setTimeout(() => {
		scrollToBottom();
	}, 500);
});

onUnload(() => {
	consultSessionStore.clear();
	chatFlowStore.clear();
});

// è¯¦æƒ…é¡µå†…å‘é€å’¨è¯¢é—®é¢˜ï¼ˆé›†æˆ /law/consult æµå¼æ¥å£ï¼‰
const handleSend = async (data: SendData) => {
	log.group("consult detail send");
	log.debug("payload ==> ", data);
	log.groupEnd();

	// æ£€æŸ¥ç™»å½•çŠ¶æ€
	if (!user.token) {
		// æ˜¾ç¤ºç™»å½•å¼¹çª—ï¼Œç™»å½•æˆåŠŸåé‡æ–°å‘é€
		showLoginModal(() => {
			// ç™»å½•æˆåŠŸåï¼Œé‡æ–°è°ƒç”¨ handleSend å‘é€æ¶ˆæ¯
			handleSend(data);
		});
		return;
	}

	// ç»Ÿä¸€æŠ½å–æœ¬æ¬¡æé—®æ–‡æœ¬ï¼š
	// - æ–‡æœ¬æ¨¡å¼ï¼šç›´æ¥ç”¨ data.text
	// - è¯­éŸ³æ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨è¯­éŸ³è¯†åˆ«å‡ºçš„æ–‡å­— data.voice.textï¼Œå…œåº• data.text
	let questionText = "";
	if (data.mode === "voice" && data.voice) {
		questionText = (data.voice.text || data.text || "").trim();
	} else {
		questionText = (data.text || "").trim();
	}

	if (!questionText) {
		ui.showToast({ message: "è¯·è¾“å…¥æˆ–è¯´å‡ºä½ çš„å’¨è¯¢é—®é¢˜" });
		return;
	}

	try {
		// å‘é€æ–°é—®é¢˜å‰ï¼Œé‡ç½®ä¸ºè‡ªåŠ¨è·Ÿéšåˆ°åº•éƒ¨
		autoScroll.value = true;
		scrollToBottom();
		// TODO - åˆ›å»ºæµå¼è¯­éŸ³åˆæˆ
		// const ttsController = await createConsultTtsController();
		try {
			inputValue.value = "";

			await consultSessionStore.sendTextQuestion(
				questionText,
				chatInputStore.tools.value,
				{
					onTextChunk: async (chunk: string) => {
						console.debug("chunk ===> ", chunk);
						// await ttsController.feedText(chunk);
					}
				},
				{
					fromVoice: data.mode === "voice",
					voiceUrl: data.mode === "voice" ? data.voice?.onlineUrl : undefined,
					voiceLength:
						data.mode === "voice" && data.voice
							? Math.ceil((data.voice.duration || 0) / 1000)
							: undefined
				}
			);
			// await ttsController.finish();
		} finally {
			// ttsController.dispose();
		}
	} catch (err) {
		console.error("consult send error", err);
		ui.showToast({ message: "å’¨è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" });
	}
};
</script>

<template>
	<app-page title="æ³•å¾‹å’¨è¯¢" back-top :use-history-layout="false" :chat-list-btn="false">
		<template #content>
			<view class="page-content">
				<view
					v-if="!hasValidLaunch"
					class="flex-1 px-4 py-6 text-center text-gray-400 text-sm"
				>
					æš‚æœªæ£€æµ‹åˆ°ä¼šè¯å¯åŠ¨å‚æ•°ï¼Œè¯·ä»é¦–é¡µå‘èµ·æ–°çš„å’¨è¯¢ã€‚
				</view>
				<view v-else class="flex-1 px-2 pt-2 pb-4">
					<scroll-view
						scroll-y
						class="ai-repeat-list__scroll"
						:enable-flex="true"
						:scroll-into-view="scrollIntoViewId"
						:scroll-with-animation="true"
						@scroll="handleScroll"
						@scrolltolower="handleScrollToLower"
					>
						<view
							v-for="(item, index) in messages"
							:key="index"
							class="flex px-4 my-2"
							:class="item.role === 'user' ? 'flex-row justify-end' : 'justify-start'"
						>
							<template v-if="item.role === 'user'">
								<template v-if="item.fromVoice">
									<view
										class="chat-user-main !w-fit px-3 py-2 rounded-xl rounded-tr-none flex flex-col gap-1"
									>
										<audio-bubble
											mode="send"
											:length="item.voiceLength"
											:url="item.voiceUrl || ''"
										/>
									</view>
									<view class="voice-text">
										{{ item.content }}
									</view>
								</template>
								<!-- æ™®é€šæ–‡æœ¬æé—®ï¼šä¿æŒåŸæœ‰æ ·å¼ -->
								<view
									v-else
									class="chat-user-main !w-fit p-2 pl-3 rounded-xl rounded-tr-none text-lg"
								>
									<cl-text
										:pt="{
											className: 'text-white'
										}"
									>
										{{ item.content }}
									</cl-text>
								</view>
							</template>

							<template v-else>
								<!-- æ€è€ƒè¿‡ç¨‹ï¼šæ˜¾ç¤ºåœ¨æ¯æ¡ AI å›å¤çš„æœ€ä¸Šæ–¹ï¼ˆå¦‚æœå­˜åœ¨ deepThinkï¼‰ -->
								<view v-if="item.deepThink" class="deepthink-wrapper">
									<view
										class="deepthink-header"
										@tap.stop="toggleDeepThink(index)"
									>
										<view class="deepthink-icon">
											<cl-text>ğŸ’­</cl-text>
										</view>
										<text class="deepthink-title">
											{{ getDeepThinkTimeText(item) }}
										</text>
										<text class="deepthink-toggle">
											<cl-icon
												:name="`arrow-${isDeepThinkExpanded(index) ? 'up-s-line' : 'down-s-line'}`"
											></cl-icon>
										</text>
									</view>
									<view v-if="isDeepThinkExpanded(index)" class="deepthink-body">
										<text class="deepthink-text">{{ item.deepThink }}</text>
									</view>
								</view>

								<template v-if="item.content">
									<zero-markdown-view
										:markdown="item.content"
										:aiMode="true"
									></zero-markdown-view>
								</template>

								<!-- æ¨èå¾‹å¸ˆå±•ç¤º -->
								<lawyer-list
									v-if="item.haveRecommendLawyer"
									:lawyers="item.recommendedLawyers || []"
									:session-id="sessionId"
									:loading="isRecommendLoading && !item.recommendedLawyers?.length"
									@lawyer-click="handleLawyerClick"
									@more-click="handleMoreLawyers"
								/>
							</template>
						</view>
						<!-- å½“å‰è½® AI å›å¤é˜¶æ®µæ€§çŠ¶æ€å±•ç¤º -->
						<view v-if="isGenerating && streamStatus" class="ai-status-wrapper">
							<view class="ai-status-row">
								<view class="ai-status-spinner"></view>
								<text class="ai-status-text">{{ streamStatus }}</text>
							</view>
							<view class="ai-status-dots">
								<view class="ai-status-dot ai-status-dot--1"></view>
								<view class="ai-status-dot ai-status-dot--2"></view>
								<view class="ai-status-dot ai-status-dot--3"></view>
							</view>
						</view>
						<!-- åº•éƒ¨é”šç‚¹ï¼šç”¨äº scroll-into-view è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ -->
						<view id="chat-bottom-a"></view>
						<view id="chat-bottom-b"></view>
					</scroll-view>
				</view>

				<chat-input
					v-model:model-value="inputValue"
					v-model:input-mode="chatInputStore.inputMode.value"
					:tools="chatInputStore.tools.value"
					:show-default-deep-think="chatInputStore.showDefaultDeepThink.value"
					:show-default-knowledge="chatInputStore.showDefaultKnowledge.value"
					:show-default-network="chatInputStore.showDefaultNetwork.value"
					@send="handleSend"
					@tool-change="handleToolsChange"
					@input-mode-change="handleInputModeChange"
				/>
			</view>
		</template>
	</app-page>
</template>

<style lang="scss" scoped>
.page-content {
	@apply w-full h-full flex flex-col overflow-hidden;
	background-color: #fafafa;
}

.ai-repeat-list__scroll {
	@apply w-full h-full flex-1 flex flex-col gap-3;
}

.chat-user-main {
	background-color: #22c57d;
}

.voice-text {
	@apply text-md pl-4 py-2 bg-white rounded-md mt-2;
}

.deepthink-wrapper {
	@apply mt-3 mb-1;
}

.deepthink-header {
	@apply flex flex-row items-center mb-1;
}

.deepthink-icon {
	border-radius: 999px;
	margin-right: 6px;
}

.deepthink-title {
	@apply text-md text-blue-500 mr-1;
}

.deepthink-toggle {
	@apply text-md text-gray-400;
}

.deepthink-body {
	@apply mt-1 pl-3 border-l border-gray-200;
}

.deepthink-text {
	@apply text-md text-gray-500 leading-relaxed;
}

.lawyer-rec-wrapper {
	@apply mt-3 px-4 py-3 bg-white rounded-xl shadow-sm;
}

.lawyer-rec-header {
	@apply text-md text-gray-500 mb-2;
}

.lawyer-rec-item {
	@apply mb-2 last:mb-0;
}

.lawyer-rec-main {
	@apply flex flex-row items-baseline gap-2;
}

.lawyer-rec-name {
	@apply text-sm text-gray-900 font-medium;
}

.lawyer-rec-title {
	@apply text-[11px] text-blue-500;
}

.lawyer-rec-firm {
	@apply block text-md text-gray-500 mt-1;
}

.lawyer-rec-expert {
	@apply block text-md text-gray-500 mt-0.5;
}

.ai-status-wrapper {
	@apply px-4 py-3;
}

.ai-status-row {
	@apply flex flex-row items-center mb-1;
}

.ai-status-spinner {
	width: 14px;
	height: 14px;
	border-radius: 999px;
	border-width: 2px;
	border-style: solid;
	border-color: #e5e7eb;
	border-top-color: #3b82f6;
	animation: ai-status-spin 1s linear infinite;
}

.ai-status-text {
	@apply text-md text-gray-500 ml-2;
}

.ai-status-dots {
	@apply flex flex-row items-center mt-1;
}

.ai-status-dot {
	width: 6px;
	height: 6px;
	border-radius: 999px;
	background-color: #3b82f6;
	margin-right: 4px;
	animation: ai-status-blink 1.4s infinite both;
}

.ai-status-dot--2 {
	animation-delay: 0.2s;
}

.ai-status-dot--3 {
	animation-delay: 0.4s;
}

@keyframes ai-status-spin {
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}

@keyframes ai-status-blink {
	0%,
	80%,
	100% {
		opacity: 0.2;
	}
	40% {
		opacity: 1;
	}
}
</style>
