<script lang="ts" setup>
import { ref, computed } from "vue";
import { useUi } from "@/uni_modules/cool-ui";
import { Logger } from "@/cool/utils/log";
import { router, useStore } from "@/cool";

import AppPage from "@/components/common/layout/app-page.uvue";
import {
	IM_APP_KEY,
	initEasemob,
	addEasemobEventHandlers,
	sendEasemobTextMessage
} from "@/utils/easemob";

const log = new Logger("TestPage");
const ui = useUi();
const { user } = useStore();

const userId = computed(() => user.info.value?.id ?? null);
const isLoggedIn = computed(() => !user.isNull());

const imUserId = ref("");
const imPeerId = ref([]);
const imInputText = ref("");

const isIMInited = ref(false);
const isConnected = ref(false);

const messages = ref<
	{
		id: string;
		from: string;
		to: string;
		text: string;
		direction: "in" | "out";
		time: number;
	}[]
>([]);

onShow(() => {
	if (!isLoggedIn.value) {
		ui.showToast({ message: "è¯·å…ˆç™»å½•ç³»ç»Ÿ" });
		router.login();
		return;
	}
	if (userId.value != null) {
		imUserId.value = String(userId.value);
	}
	ensureIMInited();
});

const ensureIMInited = () => {
	if (isIMInited.value) return;

	initEasemob({
		appKey: IM_APP_KEY,
		url: "wss://im-api-wechat.easemob.com/websocket",
		apiUrl: "https://a1.easemob.com"
	});

	addEasemobEventHandlers({
		onOpened: () => {
			isConnected.value = true;
			ui.showToast({ message: "IM å·²è¿æ¥" });
		},
		onClosed: () => {
			isConnected.value = false;
		},
		onTextMessage: (msg: any) => {
			const text = msg?.msg || msg?.data || "";
			messages.value.push({
				id: msg.id || String(Date.now()),
				from: msg.from,
				to: msg.to,
				text,
				direction: "in",
				time: Date.now()
			});
		},
		onError: (err: any) => {
			log.error("[IM] error", err);
		}
	});

	isIMInited.value = true;
};

const peers = ref([
	{ id: 28, name: "3091", imUserId: "28" },
	{ id: 30, name: "6490", imUserId: "30" },
	{ id: 71, name: "3090", imUserId: "71" },
	{ id: 72, name: "3092", imUserId: "72" },
	{ id: 73, name: "3093", imUserId: "73" }
]);

/**
 * éšæœºç”Ÿæˆä¸€å¥è‡ªç„¶çš„çœŸäººèŠå¤©è¯­å¥
 * @returns éšæœºç”Ÿæˆçš„æ—¥å¸¸å¯¹è¯å¥å­
 */
const getRandomChatMessage = (): string => {
	const messages = [
		"ä»Šå¤©å¤©æ°”çœŸä¸é”™å‘€ï½",
		"åˆšå–å®Œå’–å•¡ï¼Œæ„Ÿè§‰è¶…æœ‰ç²¾ç¥ï¼",
		"ä½ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ",
		"å“ˆå“ˆï¼Œè¿™ä¸ªæ¶ˆæ¯å¤ªå¥½ç¬‘äº†ï¼",
		"åˆšåƒå®Œé¥­ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ’‘ï½",
		"ä»Šå¤©çœ‹åˆ°ä¸€åªè¶…å¯çˆ±çš„çŒ«ï¼Œæƒ³åˆ†äº«ç»™ä½ ï¼",
		"åœ¨å—ï¼Ÿæƒ³è·Ÿä½ èŠèŠæœ€è¿‘çš„ç”µå½±",
		"çªç„¶æƒ³ä½ äº†ï¼Œä½ ä»Šå¤©è¿‡å¾—å’‹æ ·ï¼Ÿ",
		"è¿™ä¸ªå‘¨æœ«æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ",
		"åˆšåœ¨æ¥¼ä¸‹ä¹°äº†æ¯å¥¶èŒ¶ï¼Œå¥½å–åˆ°æƒ³å“­ï¼",
		"æœ€è¿‘å‹åŠ›æœ‰ç‚¹å¤§ï¼Œä½†çœ‹åˆ°ä½ æ¶ˆæ¯å¿ƒæƒ…å¥½å¤šäº†",
		"ä½ çŒœæˆ‘åˆšæ‰çœ‹åˆ°ä»€ä¹ˆäº†ï¼Ÿ",
		"ä»Šå¤©ä¸‹ç­è·¯ä¸Šçœ‹åˆ°å½©è™¹ï¼Œå¥½æ¢¦å¹»å•Š",
		"åœ¨å—ï¼Ÿæƒ³è·Ÿä½ åæ§½ä¸€ä¸‹ä»Šå¤©çš„å·¥ä½œ",
		"åˆšåˆšåœ¨å¬æ­Œï¼Œçªç„¶æƒ³åˆ°ä½ äº†",
		"æœ€è¿‘åœ¨å­¦åšèœï¼Œå¤±è´¥äº†å¥½å¤šæ¬¡ğŸ˜‚",
		"ä½ ä»Šå¤©åƒé¥­äº†å—ï¼Ÿ",
		"è¿™ä¸ªæ¶ˆæ¯å‘å¾—æœ‰ç‚¹çªç„¶ï¼Œä½†å°±æ˜¯æƒ³ä½ äº†",
		"åˆšåˆ·åˆ°ä¸€ä¸ªè¶…æç¬‘çš„è§†é¢‘ï¼Œå¿…é¡»åˆ†äº«ç»™ä½ ",
		"æœ€è¿‘åœ¨è¿½å‰§ï¼Œçœ‹åˆ°ç¬¬å‡ é›†äº†ï¼Ÿ",
		"ä»Šå¤©å¿ƒæƒ…è¶…å¥½ï¼Œæƒ³è·Ÿä½ åˆ†äº«ç‚¹å¼€å¿ƒäº‹",
		"å¿™å®Œè¿™é˜µå­ï¼Œå’±ä»¬çº¦ä¸ªé¥­å§ï¼Ÿ",
		"çªç„¶æƒ³åƒç«é”…äº†ï¼Œä½ å‘¢ï¼Ÿ",
		"ä½ æœ€è¿‘æœ‰çœ‹ä»€ä¹ˆå¥½ä¹¦å—ï¼Ÿ",
		"ä»Šå¤©è¢«åŒäº‹å¤¸äº†ï¼Œå¼€å¿ƒåˆ°é£èµ·ï¼",
		"åˆšç¡é†’ï¼Œè„‘å­è¿˜æœ‰ç‚¹æ‡µ",
		"åœ¨å—ï¼Ÿæƒ³è·Ÿä½ èŠèŠæ˜¨å¤©é‚£ä»¶äº‹",
		"è¿™ä¸ªå¤©æ°”æœ€é€‚åˆå‡ºå»èµ°èµ°äº†ï½",
		"åˆšåˆšåœ¨æƒ³ä½ ï¼Œå°±å‘ä¸ªæ¶ˆæ¯ç»™ä½ ",
		"ä»Šå¤©è¿æ°”è¶…å¥½ï¼Œè¿å¤–å–éƒ½å‡†æ—¶åˆ°äº†ï¼"
	];

	return messages[Math.floor(Math.random() * messages.length)];
};

const handleSend = async () => {
	log.info("å°è¯•ä½¿ç”¨ IM å‘é€æ¶ˆæ¯");
	if (!isLoggedIn.value || !userId.value) {
		ui.showToast({ message: "è¯·å…ˆå®Œæˆç³»ç»Ÿç™»å½•" });
		router.login();
		return;
	}

	let content = imInputText.value.trim();
	if (!content) {
		content = getRandomChatMessage();
	}
	// if (!isConnected.value) {
	// 	ui.showToast({ message: "è¯·å…ˆç™»å½• IM" });
	// 	return;
	// }
	if (!imPeerId.value) {
		ui.showToast({ message: "è¯·è¾“å…¥å¯¹ç«¯ç”¨æˆ· ID" });
		return;
	}

	log.info(`ç›®æ ‡ ID: ${imPeerId.value}`);

	try {
		imPeerId.value.map(async (item) => {
			await sendEasemobTextMessage({
				to: item,
				chatType: "singleChat",
				msg: content
			});

			messages.value.push({
				id: `out_${Date.now()}`,
				from: imUserId.value,
				to: item,
				text: content,
				direction: "out",
				time: Date.now()
			});
		});

		imInputText.value = "";
	} catch (err: any) {
		log.error("[IM] å‘é€å¤±è´¥", err);
		ui.showToast({ message: "æ¶ˆæ¯å‘é€å¤±è´¥" });
	}
};

//#region æ»šåŠ¨ç›¸å…³

//#endregion
</script>

<template>
	<app-page title="IM æ–‡æœ¬èŠå¤©æµ‹è¯•" back-top>
		<template #content>
			<view class="p-3 my-3">
				<view class="text-xs text-gray-500">
					IM çŠ¶æ€ï¼š{{ isConnected ? "å·²è¿æ¥" : "æœªè¿æ¥" }}
				</view>

				<view class="flex flex-col gap-2">
					<input
						v-model="imUserId"
						disabled
						placeholder="IM ç”¨æˆ·åï¼ˆè‡ªåŠ¨ä½¿ç”¨ user_idï¼‰"
						class="flex-1 px-2 py-1 border rounded text-sm bg-gray-100"
					/>
					<view class="text-[11px] text-gray-500">
						IM å·²éšç³»ç»Ÿè´¦å·è‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€æ‰‹åŠ¨ç™»å½•ã€‚
					</view>
				</view>

				<view class="flex flex-col gap-2 mt-2">
					<view class="flex flex-warp gap-4">
						<template v-for="item in peers" :key="item.id">
							<cl-checkbox
								v-model="imPeerId"
								:value="item.imUserId"
								:show-icon="false"
							>
								{{ `${item.id}-${item.name}` }}
							</cl-checkbox>
						</template>
					</view>

					<view class="flex gap-2">
						<input
							v-model="imInputText"
							placeholder="è¾“å…¥è¦å‘é€çš„æ–‡æœ¬æ¶ˆæ¯"
							class="flex-1 px-2 py-1 border rounded text-sm"
						/>
						<cl-button class="px-3 py-1" type="success" @click="handleSend">
							å‘é€
						</cl-button>
					</view>
				</view>

				<scroll-view scroll-y class="mt-3 h-[320px] border rounded p-2 bg-white">
					<view v-for="m in messages" :key="m.id" class="mb-2 text-sm">
						<view class="text-gray-500 text-[10px] mb-1">
							{{ m.direction === "out" ? "æˆ‘ â†’ " + m.to : m.from + " â†’ æˆ‘" }}
						</view>
						<view
							:class="[
								'inline-block px-2 py-1 rounded',
								m.direction === 'out'
									? 'bg-blue-500 text-white self-end'
									: 'bg-gray-100 text-gray-900'
							]"
						>
							{{ m.text }}
						</view>
					</view>
					<view id="chat-bottom-b"></view>
				</scroll-view>
			</view>
		</template>
	</app-page>
</template>

<style lang="scss" scoped></style>
