<script setup lang="ts">
import { getCurrentInstance, onMounted, ref, computed, nextTick } from "vue";

// 引入 Recorder-UniCore 所需依赖
import "recorder-core";
import RecordApp from "recorder-core/src/app-support/app";
import "@/uni_modules/Recorder-UniCore/app-uni-support.js";

// #ifdef MP-WEIXIN
import "recorder-core/src/app-support/app-miniProgram-wx-support.js";
// #endif

// H5 / 小程序：引入 mp3 编码和波形扩展
// #ifdef H5 || MP-WEIXIN
import "recorder-core/src/engine/mp3";
import "recorder-core/src/engine/mp3-engine";
import "recorder-core/src/extensions/waveview";
// #endif

declare const Recorder: any;

const emit = defineEmits<{
	(
		e: "emitCheck",
		payload:
			| boolean
			| { status: boolean; path: { src: string; switchStatus: boolean; soundTime: number }[] }
	): void;
}>();

const instance = getCurrentInstance();
const vue3This = instance!.proxy as any;

// 录音状态：send / cancel / translate
const MAX_DURATION = 12_000; // 录制最大时长（毫秒）
type Mode = "send" | "cancel" | "translate";
const mode = ref<Mode>("send");

const waveViewConfig = ref<any>({
	width: 160,
	height: 40,
	canvas: null
});
const isRecording = ref(false);
const showOverlay = ref(false);
const startPageY = ref(0);
const hasPermission = ref(false);
const windowWidth = ref<number | null>(null);

// 本地录音列表，用于在页面上回显并播放
const records = ref<{ src: string; soundTime: number; mode: Mode }[]>([]);

// 播放用的全局音频实例
let innerPlayer: UniApp.InnerAudioContext | null = null;

// 调试信息
const debugLines = ref<string[]>([]);
const durationMs = ref(0);

const mainText = computed(() => {
	if (!isRecording.value) return "按住 说话";
	if (mode.value === "cancel") return "松开 手指，取消发送";
	if (mode.value === "translate") return "松开 手指，转为文字";
	return "松开 发送";
});

const overlayText = computed(() => {
	if (!isRecording.value) return "";
	if (mode.value === "send") return "松开手指，发送";
	if (mode.value === "cancel") return "松开手指，取消发送";
	if (mode.value === "translate") return "松开手指，转为文字";
	// 进入最后 10 秒时，用 tip 提醒剩余录制时间
	const remainMs = MAX_DURATION - durationMs.value;
	if (remainMs > 0 && remainMs <= 10_000) {
		const remainSec = Math.ceil(remainMs / 1000);
		return `还可以录制 ${remainSec} 秒`;
	}
	return "正在录音... 上滑或左右滑动选择";
});

const debugText = computed(() => debugLines.value.join("\n"));

function pushDebug(msg: string, extra?: any) {
	const time = new Date().toLocaleTimeString();
	let line = `[${time}] ${msg}`;
	if (extra !== undefined) {
		try {
			line += " " + JSON.stringify(extra);
		} catch {
			// ignore
		}
	}
	debugLines.value = [...debugLines.value.slice(-20), line];
}

// 初始化页面环境
onMounted(() => {
	RecordApp.UniPageOnShow(vue3This);
	if (!windowWidth.value) {
		const info = uni.getSystemInfoSync();
		windowWidth.value = info.windowWidth;
	}

	// 初始化播放实例
	innerPlayer = uni.createInnerAudioContext();
	innerPlayer.autoplay = false;
	innerPlayer.onError((err) => {
		pushDebug("播放失败", err);
	});
});

function ensurePermission(): Promise<void> {
	return new Promise((resolve, reject) => {
		RecordApp.UniWebViewActivate(vue3This);
		if (hasPermission.value) {
			resolve();
			return;
		}
		RecordApp.RequestPermission(
			() => {
				hasPermission.value = true;
				pushDebug("权限请求成功");
				resolve();
			},
			(msg: any) => {
				console.error("请求录音权限失败：", msg);
				pushDebug("权限请求失败", msg);
				reject(new Error(String(msg)));
			}
		);
	});
}

function handleTouchStart(e: any) {
	startPageY.value = e.touches[0].pageY;
	mode.value = "send";
	pushDebug("touchstart", { y: startPageY.value });

	ensurePermission()
		.then(() => {
			const set = {
				type: "mp3",
				// 16k 语音足够，体积也小
				sampleRate: 16000,
				// 比特率，越高音质越好，文件越大
				bitRate: 16,
				onProcess: (
					buffers: Int16Array[],
					powerLevel: number,
					duration: number,
					sampleRate: number
				) => {
					durationMs.value = duration;
					// H5、微信用 waveview
					// #ifdef H5 || MP-WEIXIN
					const waveView = (vue3This as any).waveView;
					if (waveView && buffers.length) {
						waveView.input(buffers[buffers.length - 1], powerLevel, sampleRate);
					}
					// #endif
					// 简单的最长录音时长控制：超过 60 秒自动结束
					if (duration >= MAX_DURATION && isRecording.value) {
						pushDebug("达到最大录音时长，自动结束", { durationMs: duration });
						isRecording.value = false;
						showOverlay.value = false;
						stopAndEmit(false);
					}
				}
			};

			RecordApp.UniWebViewActivate(vue3This);
			RecordApp.Start(
				set,
				() => {
					isRecording.value = true;
					showOverlay.value = true;
					pushDebug("开始录音");
					// 初始化波形 canvas：等遮罩和气泡渲染完再查找 canvas
					// #ifdef H5 || MP-WEIXIN
					nextTick(() => {
						RecordApp.UniFindCanvas(
							vue3This,
							[".recwave-WaveView"],
							`
								this.waveView = Recorder.WaveView({
									compatibleCanvas: canvas1,
									width: ${waveViewConfig.value.width},
									height: ${waveViewConfig.value.height},
								});
					`,
							(canvas1: any) => {
								(vue3This as any).waveView = Recorder.WaveView({
									compatibleCanvas: canvas1,
									width: waveViewConfig.value.width / 4,
									height: waveViewConfig.value.height / 2
									// linear1: [0, "rgba(126,211,33,1)", 1, "rgba(70,160,10,1)"],
									// linear2: [0, "rgba(126,211,33,0.4)", 1, "rgba(70,160,10,0.4)"],
									// linearBg: [
									// 	0,
									// 	"rgba(255,255,255,0.0)",
									// 	1,
									// 	"rgba(255,255,255,0.0)"
									// ]
								});
								waveViewConfig.value.canvas = canvas1;
							}
						);
					});
					// #endif
				},
				(msg: any) => {
					console.error("开始录音失败：", msg);
					pushDebug("开始录音失败", msg);
					isRecording.value = false;
					showOverlay.value = false;
				}
			);
		})
		.catch(() => {
			// 无权限，直接结束
			isRecording.value = false;
			showOverlay.value = false;
		});
}

function updateModeByTouch(e: any) {
	if (!windowWidth.value) return;
	const x = e.touches[0].pageX;
	const w = windowWidth.value;
	if (x < w / 3) {
		mode.value = "cancel";
	} else if (x > (2 * w) / 3) {
		mode.value = "translate";
	} else {
		mode.value = "send";
	}
}

function handleTouchMove(e: any) {
	if (!isRecording.value) return;
	// 仅根据左右位置判断：左 1/3 取消，中间发送，右 1/3 转文字
	updateModeByTouch(e);
}

function stopAndEmit(isCancel: boolean) {
	RecordApp.Stop(
		(arrayBuffer: ArrayBuffer, duration: number, mime: string) => {
			// 统一的回调结构：status + path[{src,switchStatus,soundTime}]
			const soundTime = Math.max(1, Math.round(duration / 1000));
			pushDebug("录音完成", { durationMs: duration, soundTime, mode: mode.value });

			// H5 直接构造 blob url
			// 小程序 / App 保存成本地文件
			// #ifdef H5
			const blob = new Blob([arrayBuffer], { type: mime });
			const urlCreator = (window.URL || (window as any).webkitURL) as typeof URL;
			const src = urlCreator.createObjectURL(blob);
			// 记录到本地列表，方便页面播放
			records.value = [{ src, soundTime, mode: mode.value }, ...records.value].slice(0, 10);
			emit("emitCheck", {
				status: !isCancel,
				path: [
					{
						src,
						switchStatus: false,
						soundTime
					}
				]
			});
			// #endif

			// #ifdef APP || MP-WEIXIN
			RecordApp.UniSaveLocalFile(
				"recorder.mp3",
				arrayBuffer,
				(savePath: string) => {
					// 记录到本地列表
					records.value = [
						{ src: savePath, soundTime, mode: mode.value },
						...records.value
					].slice(0, 10);
					emit("emitCheck", {
						status: !isCancel,
						path: [
							{
								src: savePath,
								switchStatus: false,
								soundTime
							}
						]
					});
				},
				(err: string) => {
					console.error("保存录音失败：", err);
					pushDebug("保存录音失败", err);
					emit("emitCheck", false);
				}
			);
			// #endif
		},
		(msg: any) => {
			console.error("结束录音失败：", msg);
			pushDebug("结束录音失败", msg);
			emit("emitCheck", false);
		}
	);
}

function handleTouchEnd() {
	if (!isRecording.value) return;
	const isCancel = mode.value === "cancel";
	isRecording.value = false;
	showOverlay.value = false;
	pushDebug("touchend", { mode: mode.value, isCancel });
	stopAndEmit(isCancel);
}

function playRecord(src: string) {
	if (!src) return;
	if (!innerPlayer) {
		innerPlayer = uni.createInnerAudioContext();
		innerPlayer.autoplay = false;
	}
	innerPlayer.stop();
	innerPlayer.src = src;
	pushDebug("播放录音", { src });
	innerPlayer.play();
}
</script>

<template>
	<cl-page>
		<!-- 顶部遮罩 + 绿色气泡 -->
		<view v-if="showOverlay" class="voice-record-mask">
			<view class="voice-record-center">
				<view
					class="voice-record-bubble"
					:style="{ minWidth: waveViewConfig.width + 'px' }"
				>
					<view
						class="voice-record-wave"
						:style="{
							width: waveViewConfig.width + 'px',
							height: waveViewConfig.height + 'px'
						}"
					>
						<canvas
							class="w-full recwave-WaveView"
							type="2d"
							:style="{
								height: `${waveViewConfig.height / 2}px`
							}"
						></canvas>
					</view>
				</view>
				<view class="voice-record-tip" :class="{ cancel: mode === 'cancel' }">
					<text>{{ overlayText }}</text>
				</view>
			</view>
		</view>
		<view class="voice-record-page">
			<!-- 调试信息 -->
			<view class="flex-1 flex flex-col gap-2">
				<view class="voice-record-debug">
					<text class="debug-title">调试信息（仅测试环境）</text>
					<text class="debug-line">模式：{{ mode }}</text>
					<text class="debug-line">录音时长：{{ Math.round(durationMs / 1000) }}s</text>
					<text class="debug-log">{{ debugText }}</text>
				</view>

				<!-- 调试信息：录音列表回显 -->
				<view class="voice-record-list">
					<text class="debug-title">录音列表（最多 10 条，点击播放）</text>
					<view v-if="records.length === 0" class="debug-line">暂无录音</view>
					<view v-for="(item, idx) in records" :key="idx" class="record-item">
						<text class="debug-line">
							#{{ idx + 1 }} [{{ item.mode }}] {{ item.soundTime }}s
						</text>
						<view class="record-play" @tap.stop="playRecord(item.src)">
							<text>播放</text>
						</view>
					</view>
				</view>
			</view>

			<!-- 底部按住说话按钮 + 左右操作区 -->
			<view class="voice-record-footer">
				<!-- 录音中时：在底部按钮上方展示左右两个操作按钮 -->
				<view v-if="isRecording" class="voice-record-bottom-row">
					<view class="voice-record-pill left" :class="{ active: mode === 'cancel' }">
						<text>取消</text>
					</view>
					<view class="voice-record-pill right" :class="{ active: mode === 'translate' }">
						<text>滑到这里 转文字</text>
					</view>
				</view>

				<!-- 底部主按钮：按住说话 / 松开发送 -->
				<view
					class="footer-btn"
					@touchstart.stop.prevent="handleTouchStart"
					@touchmove.stop.prevent="handleTouchMove"
					@touchend.stop.prevent="handleTouchEnd"
				>
					<text>{{ mainText }}</text>
				</view>
			</view>
		</view>
	</cl-page>
</template>

<style scoped lang="scss">
.voice-record-page {
	@apply relative h-screen w-full flex flex-col gap-4;
}

.voice-record-mask {
	@apply fixed inset-0 z-[999] flex flex-col items-center justify-center;
	background-color: rgba(0, 0, 0, 0.4);
}

.voice-record-center {
	@apply flex flex-col items-center justify-center w-full;
}

.voice-record-bubble {
	@apply rounded-[24px] px-8 py-4 flex items-center justify-center shadow-lg mx-6;
	background-color: #7ed321;
}

.voice-record-wave {
	@apply justify-center rounded-full overflow-hidden relative;
}

.voice-record-wave::after {
	content: "";
	position: absolute;
	inset: 0;
	background-image: repeating-linear-gradient(
		90deg,
		transparent,
		transparent 3px,
		rgba(0, 0, 0, 0.4) 4px,
		rgba(0, 0, 0, 0.4) 8px
	);
	animation: voice-wave 1.2s linear infinite;
}

.voice-record-tip {
	@apply mt-4 px-4 py-2 rounded-full bg-[rgba(0,0,0,0.6)];
	color: #fff;
	font-size: 14px;
}

.voice-record-tip.cancel {
	background-color: rgba(250, 83, 83, 0.8);
}

.voice-record-footer {
	@apply absolute left-0 right-0 bottom-0 px-6 pb-10;
}

.footer-btn {
	@apply w-full h-[64px] rounded-full flex items-center justify-center;
	background-color: #f3f4f6;
	font-size: 16px;
	color: #111827;
}

.voice-record-touch-area {
	@apply w-full h-[160px] relative;
}

.voice-record-bottom-row {
	@apply w-full flex flex-row items-end justify-between px-2;
}

.voice-record-pill {
	@apply w-[40%] h-[70px] rounded-full flex items-center justify-center;
	background-color: rgba(0, 0, 0, 0.35);
	color: #fff;
	font-size: 14px;
	transform: translateY(18px);
}

.voice-record-pill.active {
	background-color: rgba(15, 23, 42, 0.9);
}

.voice-record-bottom-center {
	@apply absolute left-1/2 -translate-x-1/2 bottom-0 w-[120px] h-[120px] rounded-full flex items-center justify-center shadow-xl;
	background-color: rgba(255, 255, 255, 0.96);
}

.voice-record-bottom-center.active {
	background-color: #ffffff;
}

.voice-record-bottom-center-text {
	@apply text-center;
	font-size: 16px;
	color: #111827;
}

.voice-record-debug {
	@apply flex-1 flex px-4 pt-4 pb-8 mt-4 border-t border-dashed border-gray-300 overflow-auto;
	font-size: 12px;
	color: #4b5563;
}

.debug-title {
	@apply font-semibold mb-1;
}

.debug-line {
	@apply mb-1;
}

.debug-log {
	@apply mt-1 whitespace-pre-line break-words;
}

.voice-record-list {
	@apply px-4 pb-8 flex-1 flex flex-col gap-2 overflow-auto;
}

.record-item {
	@apply mt-2;
}

.record-play {
	@apply mt-1 inline-flex px-3 py-1 rounded-full bg-primary-500 text-white text-xs;
}

@keyframes voice-wave {
	0% {
		transform: translateX(0);
	}
	100% {
		transform: translateX(-40px);
	}
}
</style>
