<script lang="ts" setup>
import { ref, reactive } from "vue";
import { useUi } from "@/uni_modules/cool-ui";
import { Logger } from "@/cool/utils/log";
import { parseClass, router } from "@/cool";
import {
	PermissionScope,
	requestPermission,
	checkPermission,
	checkMultiplePermissions,
	requestMultiplePermissions
} from "@/utils/permission";

import {
	WxLogin,
	CreateJsApiOrder,
	GetOrderStatus,
	CloseOrder,
	GetOrderList,
	RegeneratePayment,
	type OrderInfo
} from "@/api/payment/wx";

import AppPage from "@/components/common/layout/app-page.uvue";

const log = new Logger("TestPage-Setting");
const ui = useUi();

// ==================== æŠ˜å é¢æ¿çŠ¶æ€ ====================
const collapseState = reactive({
	wxPay: false,
	wxRealPay: false,
	permission: false
});

//#region å¾®ä¿¡æ”¯ä»˜æµ‹è¯•
const wxLoginCode = ref("");
const wxLoginLoading = ref(false);

// æ”¯ä»˜å‚æ•°
const payParams = reactive({
	timeStamp: "",
	nonceStr: "",
	package: "",
	signType: "RSA",
	paySign: ""
});

// JSON è§£æè¾“å…¥
const jsonInput = ref("");

// è·å–å¾®ä¿¡ç™»å½• code
const getWxLoginCode = () => {
	wxLoginLoading.value = true;
	uni.login({
		provider: "weixin",
		success: (res) => {
			wxLoginCode.value = res.code ?? "";
			addLog(`âœ… è·å– code æˆåŠŸ: ${wxLoginCode.value}`);
		},
		fail: (err) => {
			addLog(`âŒ è·å– code å¤±è´¥: ${JSON.stringify(err)}`);
			ui.showToast({ message: "è·å– code å¤±è´¥" });
		},
		complete: () => {
			wxLoginLoading.value = false;
		}
	});
};

// å¤åˆ¶ code
const copyCode = () => {
	if (!wxLoginCode.value) {
		// ui.showToast({ message: "è¯·å…ˆè·å– code" });
		return;
	}
	uni.setClipboardData({
		data: wxLoginCode.value,
		success: () => {
			// ui.showToast({ message: "å¤åˆ¶æˆåŠŸ" });
		}
	});
};

// è§£æ JSON å¡«å……å‚æ•°
const parseJsonParams = () => {
	if (!jsonInput.value.trim()) {
		// ui.showToast({ message: "è¯·å…ˆç²˜è´´ JSON" });
		return;
	}
	try {
		const parsed = JSON.parse(jsonInput.value.trim());
		if (parsed.timeStamp) payParams.timeStamp = String(parsed.timeStamp);
		if (parsed.nonceStr) payParams.nonceStr = parsed.nonceStr;
		if (parsed.package) payParams.package = parsed.package;
		if (parsed.signType) payParams.signType = parsed.signType;
		if (parsed.paySign) payParams.paySign = parsed.paySign;
		addLog("âœ… JSON è§£ææˆåŠŸ");
		ui.showToast({ message: "è§£ææˆåŠŸ" });
	} catch (err) {
		addLog(`âŒ JSON è§£æå¤±è´¥: ${err}`);
		ui.showToast({ message: "JSON æ ¼å¼é”™è¯¯" });
	}
};

// å‘èµ·æ”¯ä»˜è¯·æ±‚ï¼ˆæ‰‹åŠ¨å¡«å†™å‚æ•°æµ‹è¯•ï¼‰
const requestPayment = () => {
	if (!payParams.timeStamp || !payParams.nonceStr || !payParams.package || !payParams.paySign) {
		ui.showToast({ message: "è¯·å¡«å†™å®Œæ•´æ”¯ä»˜å‚æ•°" });
		return;
	}

	const orderInfo = {
		timeStamp: String(payParams.timeStamp),
		nonceStr: String(payParams.nonceStr),
		package: String(payParams.package),
		signType: String(payParams.signType),
		paySign: String(payParams.paySign)
	};

	addLog("å¼€å§‹å‘èµ·å¾®ä¿¡æ”¯ä»˜...");
	addLog(`orderInfo: ${JSON.stringify(orderInfo)}`);

	//@ts-ignore
	uni.requestPayment({
		provider: "wxpay",
		...orderInfo,
		success: (res) => {
			addLog(`âœ… æ”¯ä»˜æˆåŠŸ: ${JSON.stringify(res)}`);
			log.info(`âœ… æ”¯ä»˜æˆåŠŸ: ${JSON.stringify(res)}`);
			ui.showToast({ message: "æ”¯ä»˜æˆåŠŸ" });
		},
		fail: (res) => {
			addLog(`âŒ æ”¯ä»˜å¤±è´¥: ${JSON.stringify(res)}`);
			log.error(`âŒ æ”¯ä»˜å¤±è´¥: ${JSON.stringify(res)}`);
			ui.showToast({ message: `æ”¯ä»˜å¤±è´¥: ${JSON.stringify(res)}` });
		},
		complete: (res) => {
			addLog(`æ”¯ä»˜å®Œæˆ: ${JSON.stringify(res)}`);
			log.info(`æ”¯ä»˜å®Œæˆ: ${JSON.stringify(res)}`);
		}
	});
};
//#endregion

//#region çœŸå®æ”¯ä»˜æµ‹è¯•
const realPayState = reactive({
	openid: "",
	sessionKey: "",
	outTradeNo: "",
	loading: false,
	step: 1 // 1: åˆ›å»ºè®¢å•, 2: å‘èµ·æ”¯ä»˜
});

// å¥—é¤é€‰é¡¹
const packageOptions = [{ id: 1, name: "æµ‹è¯•å•†å“", price: "0.01" }];
const selectedPackageId = ref(1);

// é™é»˜è·å– openidï¼ˆè¿”å› Promiseï¼‰
const ensureOpenId = (): Promise<string> => {
	return new Promise((resolve, reject) => {
		// å·²æœ‰ openid ç›´æ¥è¿”å›
		if (realPayState.openid) {
			resolve(realPayState.openid);
			return;
		}

		uni.login({
			provider: "weixin",
			success: async (loginRes) => {
				const code = loginRes.code ?? "";
				try {
					const res = await WxLogin({ code });
					realPayState.openid = res.openid;
					realPayState.sessionKey = res.session_key;
					resolve(res.openid);
				} catch (err: any) {
					addLog(`âŒ è·å– openid å¤±è´¥: ${err?.message || JSON.stringify(err)}`);
					reject(err);
				}
			},
			fail: (err) => {
				addLog(`âŒ è·å– code å¤±è´¥: ${JSON.stringify(err)}`);
				reject(err);
			}
		});
	});
};

// åˆ›å»ºè®¢å•ï¼ˆå†…éƒ¨é™é»˜è·å– openidï¼‰
const createRealOrder = async () => {
	realPayState.loading = true;
	addLog("ğŸ“ åˆ›å»ºè®¢å•ä¸­...");

	try {
		// é™é»˜è·å– openid
		const openid = await ensureOpenId();

		const res = await CreateJsApiOrder({
			openid,
			package_id: selectedPackageId.value
		});

		realPayState.outTradeNo = res.order.outTradeNo;

		// ä¿å­˜æ”¯ä»˜å‚æ•°
		const rp = res.requestPayment || {};
		payParams.timeStamp = rp.timeStamp;
		payParams.nonceStr = rp.nonceStr;
		payParams.package = rp.package;
		payParams.signType = rp.signType;
		payParams.paySign = rp.paySign;

		realPayState.step = 2;
		addLog(`âœ… è®¢å•åˆ›å»ºæˆåŠŸ: ${res.order.outTradeNo}`);
		ui.showToast({ message: "è®¢å•åˆ›å»ºæˆåŠŸ" });
	} catch (err: any) {
		addLog(`âŒ åˆ›å»ºè®¢å•å¤±è´¥: ${err?.message || JSON.stringify(err)}`);
		ui.showToast({ message: "åˆ›å»ºè®¢å•å¤±è´¥" });
	} finally {
		realPayState.loading = false;
	}
};

// å‘èµ·æ”¯ä»˜
const doRealPayment = () => {
	if (!payParams.timeStamp || !payParams.package) {
		ui.showToast({ message: "è¯·å…ˆåˆ›å»ºè®¢å•" });
		return;
	}

	const orderInfo = {
		timeStamp: String(payParams.timeStamp),
		nonceStr: String(payParams.nonceStr),
		package: String(payParams.package),
		signType: String(payParams.signType),
		paySign: String(payParams.paySign)
	};

	addLog("ğŸ’° å‘èµ·å¾®ä¿¡æ”¯ä»˜...");

	//@ts-ignore
	uni.requestPayment({
		provider: "wxpay",
		...orderInfo,
		success: async (res) => {
			addLog(`âœ… æ”¯ä»˜æˆåŠŸ: ${JSON.stringify(res)}`);
			ui.showToast({ message: "æ”¯ä»˜æˆåŠŸ" });
			// æ”¯ä»˜æˆåŠŸåæŸ¥è¯¢è®¢å•çŠ¶æ€ç¡®è®¤
			await checkOrderStatus();
		},
		fail: (res) => {
			addLog(`âŒ æ”¯ä»˜å¤±è´¥/å–æ¶ˆ: ${JSON.stringify(res)}`);
			ui.showToast({ message: `æ”¯ä»˜å¤±è´¥: ${res.errMsg || "ç”¨æˆ·å–æ¶ˆ"}` });
		}
	});
};

// æŸ¥è¯¢è®¢å•çŠ¶æ€
const checkOrderStatus = async () => {
	if (!realPayState.outTradeNo) {
		ui.showToast({ message: "æ²¡æœ‰å¯æŸ¥è¯¢çš„è®¢å•" });
		return;
	}

	addLog(`ğŸ” æŸ¥è¯¢è®¢å•çŠ¶æ€: ${realPayState.outTradeNo}`);

	try {
		const res = await GetOrderStatus(realPayState.outTradeNo);
		addLog(`ğŸ“‹ è®¢å•çŠ¶æ€: ${JSON.stringify(res)}`);
		ui.showToast({ message: `è®¢å•çŠ¶æ€: ${res.status}` });
	} catch (err: any) {
		addLog(`âŒ æŸ¥è¯¢å¤±è´¥: ${err?.message || JSON.stringify(err)}`);
	}
};

// å…³é—­è®¢å•
const closeCurrentOrder = async (order) => {
	addLog(`ğŸ”’ å…³é—­è®¢å•: ${order.outTradeNo}`);

	try {
		await CloseOrder(order.outTradeNo);
		addLog(`âœ… è®¢å•å·²å…³é—­`);
		ui.showToast({ message: "è®¢å•å·²å…³é—­" });
		// é‡ç½®çŠ¶æ€
		fetchOrderList();
	} catch (err: any) {
		addLog(`âŒ å…³é—­å¤±è´¥: ${err?.message || JSON.stringify(err)}`);
	}
};

// é‡æ–°æ”¯ä»˜ï¼ˆåŸºäºå·²æœ‰è®¢å•ï¼‰
const regenerateAndPay = async () => {
	if (!realPayState.outTradeNo) {
		ui.showToast({ message: "æ²¡æœ‰å¯é‡æ–°æ”¯ä»˜çš„è®¢å•" });
		return;
	}

	addLog(`ğŸ”„ é‡æ–°ç”Ÿæˆæ”¯ä»˜å‚æ•°: ${realPayState.outTradeNo}`);

	try {
		const res = await RegeneratePayment(realPayState.outTradeNo);

		const requestPayment = {
			...(res.requestPayment || {})
		};

		payParams.timeStamp = requestPayment.timeStamp;
		payParams.nonceStr = requestPayment.nonceStr;
		payParams.package = requestPayment.package;
		payParams.signType = requestPayment.signType;
		payParams.paySign = requestPayment.paySign;

		addLog(`âœ… é‡æ–°ç”ŸæˆæˆåŠŸï¼Œå¼€å§‹æ”¯ä»˜...`);
		doRealPayment();
	} catch (err: any) {
		addLog(`âŒ é‡æ–°ç”Ÿæˆå¤±è´¥: ${err?.message || JSON.stringify(err)}`);
	}
};

// è·å–è®¢å•åˆ—è¡¨
const orderList = ref<OrderInfo[]>([]);
const orderListLoading = ref(false);
const showOrderList = ref(false);

const fetchOrderList = async () => {
	addLog(`ğŸ“‹ è·å–è®¢å•åˆ—è¡¨...`);
	orderListLoading.value = true;

	try {
		const res = await GetOrderList({ page: 1, pageSize: 10 });
		orderList.value = res.orders;
		showOrderList.value = true;
		addLog(`âœ… è·å–æˆåŠŸï¼Œå…± ${res.total} æ¡è®¢å•`);
	} catch (err: any) {
		addLog(`âŒ è·å–å¤±è´¥: ${err?.message || JSON.stringify(err)}`);
	} finally {
		orderListLoading.value = false;
	}
};

// æ ¼å¼åŒ–çŠ¶æ€
const formatStatus = (status: string): string => {
	const map: Record<string, string> = {
		PREPAY: "å¾…æ”¯ä»˜",
		SUCCESS: "å·²æ”¯ä»˜",
		unpaid: "æœªæ”¯ä»˜",
		CLOSED: "å·²å…³é—­"
	};
	return map[status] || status;
};

// æ ¼å¼åŒ–é‡‘é¢ï¼ˆåˆ†è½¬å…ƒï¼‰
const formatFee = (fee: number): string => {
	return (fee / 100).toFixed(2);
};

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (time: string): string => {
	return time?.replace("T", " ").slice(0, 16) || "";
};

// é‡ç½®çœŸå®æ”¯ä»˜çŠ¶æ€
const resetRealPayState = () => {
	realPayState.openid = "";
	realPayState.sessionKey = "";
	realPayState.outTradeNo = "";
	realPayState.step = 1;
	addLog("ğŸ”„ å·²é‡ç½®æ”¯ä»˜çŠ¶æ€");
};

//#endregion

//#region æ—¥å¿—ç³»ç»Ÿ
const testLog = ref<string[]>([]);

const addLog = (message: string) => {
	const time = new Date().toLocaleTimeString();
	testLog.value.unshift(`[${time}] ${message}`);
	if (testLog.value.length > 30) {
		testLog.value.pop();
	}
};

const clearLog = () => {
	testLog.value = [];
};
//#endregion

//#region æƒé™æµ‹è¯•
const testCameraPermission = async () => {
	addLog("å¼€å§‹ç”³è¯·ç›¸æœºæƒé™...");
	const result = await requestPermission({
		scope: PermissionScope.CAMERA,
		onSuccess: () => {
			addLog("âœ… ç›¸æœºæƒé™ç”³è¯·æˆåŠŸï¼");
		},
		onDenied: () => {
			addLog("âŒ ç›¸æœºæƒé™è¢«æ‹’ç»");
		}
	});
	addLog(`ç»“æœ: ${JSON.stringify(result)}`);
};

const testRecordPermission = async () => {
	addLog("å¼€å§‹ç”³è¯·å½•éŸ³æƒé™...");
	const result = await requestPermission({
		scope: PermissionScope.RECORD,
		onSuccess: () => {
			addLog("âœ… å½•éŸ³æƒé™ç”³è¯·æˆåŠŸï¼");
		},
		onDenied: () => {
			addLog("âŒ å½•éŸ³æƒé™è¢«æ‹’ç»");
		}
	});
	addLog(`ç»“æœ: ${JSON.stringify(result)}`);
};

const testLocationPermission = async () => {
	addLog("å¼€å§‹ç”³è¯·ä½ç½®æƒé™...");
	const result = await requestPermission({
		scope: PermissionScope.LOCATION,
		onSuccess: () => {
			addLog("âœ… ä½ç½®æƒé™ç”³è¯·æˆåŠŸï¼");
		},
		onDenied: () => {
			addLog("âŒ ä½ç½®æƒé™è¢«æ‹’ç»");
		}
	});
	addLog(`ç»“æœ: ${JSON.stringify(result)}`);
};

const testAlbumPermission = async () => {
	addLog("å¼€å§‹ç”³è¯·ç›¸å†Œæƒé™...");
	const result = await requestPermission({
		scope: PermissionScope.ALBUM,
		onSuccess: () => {
			addLog("âœ… ç›¸å†Œæƒé™ç”³è¯·æˆåŠŸï¼");
		},
		onDenied: () => {
			addLog("âŒ ç›¸å†Œæƒé™è¢«æ‹’ç»");
		}
	});
	addLog(`ç»“æœ: ${JSON.stringify(result)}`);
};

const testCustomPermission = async () => {
	addLog("å¼€å§‹ç”³è¯·è‡ªå®šä¹‰æƒé™ï¼ˆæ— ç¡®è®¤å¼¹çª—ï¼‰...");
	const result = await requestPermission({
		scope: PermissionScope.CAMERA,
		customName: "è‡ªå®šä¹‰ç›¸æœºæƒé™",
		customDescription: "è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æƒé™æè¿°",
		showConfirm: false,
		onSuccess: () => {
			addLog("âœ… è‡ªå®šä¹‰æƒé™ç”³è¯·æˆåŠŸï¼");
		},
		onDenied: () => {
			addLog("âŒ è‡ªå®šä¹‰æƒé™è¢«æ‹’ç»");
		}
	});
	addLog(`ç»“æœ: ${JSON.stringify(result)}`);
};

const toTestPage = () => {
	router.to("/ai-chat-module/voice-call/index");
};
//#endregion
</script>

<template>
	<app-page title="æµ‹è¯•æ¨¡å—" back-top>
		<template #content>
			<view class="test-container">
				<!-- å¾®ä¿¡æ”¯ä»˜æµ‹è¯• -->
				<view class="section">
					<view class="section-header" @tap="collapseState.wxPay = !collapseState.wxPay">
						<view class="section-title">
							<cl-icon
								name="money-cny-circle-line"
								:size="40"
								color="primary"
							></cl-icon>
							<cl-text size="lg" bold>å¾®ä¿¡æ”¯ä»˜æµ‹è¯•</cl-text>
						</view>
						<cl-icon
							name="arrow-down-s-line"
							:size="36"
							:pt="{
								className: parseClass([
									'text-surface-400 duration-200',
									{ '-rotate-180': collapseState.wxPay }
								])
							}"
						></cl-icon>
					</view>

					<cl-collapse v-model="collapseState.wxPay">
						<view class="collapse-content">
							<!-- Step 1: è·å– Code -->
							<view class="step-card">
								<view class="step-header">
									<view class="step-badge">1</view>
									<cl-text bold>è·å–ç™»å½• Code</cl-text>
								</view>
								<view class="step-content">
									<view class="code-display">
										<view class="code-box">
											<cl-text
												size="sm"
												:color="wxLoginCode ? 'default' : 'info'"
												:pt="{ className: 'break-all' }"
											>
												{{ wxLoginCode || "ç‚¹å‡»æŒ‰é’®è·å– code" }}
											</cl-text>
										</view>
									</view>
									<view class="action-row">
										<cl-button
											type="primary"
											size="small"
											:loading="wxLoginLoading"
											@tap="getWxLoginCode"
										>
											{{ wxLoginCode ? "é‡æ–°è·å–" : "è·å– Code" }}
										</cl-button>
										<cl-button
											type="success"
											size="small"
											:disabled="!wxLoginCode"
											@tap="copyCode"
										>
											å¤åˆ¶
										</cl-button>
									</view>
								</view>
							</view>

							<!-- Step 2: æ”¯ä»˜å‚æ•° -->
							<view class="step-card">
								<view class="step-header">
									<view class="step-badge">2</view>
									<cl-text bold>å¡«å†™æ”¯ä»˜å‚æ•°</cl-text>
								</view>
								<view class="step-content">
									<!-- JSON å¿«æ·è§£æ -->
									<view class="json-parse-area">
										<cl-text size="sm" color="info"
											>å¿«æ·å¡«å……ï¼šç²˜è´´ JSON ä¸€é”®è§£æ</cl-text
										>
										<view class="json-input-wrapper">
											<textarea
												class="json-textarea"
												v-model="jsonInput"
												placeholder="ç²˜è´´åŒ…å« timeStamp, nonceStr, package, signType, paySign çš„ JSON"
												:maxlength="-1"
											></textarea>
											<cl-button
												type="primary"
												size="small"
												:pt="{ className: 'parse-btn' }"
												@tap="parseJsonParams"
											>
												è§£æ
											</cl-button>
										</view>
									</view>

									<!-- åˆ†éš”çº¿ -->
									<view class="divider">
										<view class="divider-line"></view>
										<cl-text size="xs" color="info">æˆ–æ‰‹åŠ¨å¡«å†™</cl-text>
										<view class="divider-line"></view>
									</view>

									<!-- å‚æ•°è¾“å…¥ -->
									<view class="param-list">
										<view class="param-item">
											<cl-text size="sm" :pt="{ className: 'param-label' }"
												>timeStamp</cl-text
											>
											<cl-input
												v-model="payParams.timeStamp"
												placeholder="æ—¶é—´æˆ³"
												:border="false"
												:pt="{ className: 'param-input' }"
											></cl-input>
										</view>
										<view class="param-item">
											<cl-text size="sm" :pt="{ className: 'param-label' }"
												>nonceStr</cl-text
											>
											<cl-input
												v-model="payParams.nonceStr"
												placeholder="éšæœºå­—ç¬¦ä¸²"
												:border="false"
												:pt="{ className: 'param-input' }"
											></cl-input>
										</view>
										<view class="param-item">
											<cl-text size="sm" :pt="{ className: 'param-label' }"
												>package</cl-text
											>
											<cl-input
												v-model="payParams.package"
												placeholder="prepay_id=xxx"
												:border="false"
												:pt="{ className: 'param-input' }"
											></cl-input>
										</view>
										<view class="param-item">
											<cl-text size="sm" :pt="{ className: 'param-label' }"
												>signType</cl-text
											>
											<cl-input
												v-model="payParams.signType"
												placeholder="RSA"
												:border="false"
												:pt="{ className: 'param-input' }"
											></cl-input>
										</view>
										<view class="param-item">
											<cl-text size="sm" :pt="{ className: 'param-label' }"
												>paySign</cl-text
											>
											<cl-input
												v-model="payParams.paySign"
												placeholder="ç­¾å"
												:border="false"
												:pt="{ className: 'param-input' }"
											></cl-input>
										</view>
									</view>
								</view>
							</view>

							<!-- Step 3: å‘èµ·æ”¯ä»˜ -->
							<view class="step-card">
								<view class="step-header">
									<view class="step-badge">3</view>
									<cl-text bold>å‘èµ·æ”¯ä»˜</cl-text>
								</view>
								<view class="step-content">
									<cl-button
										type="primary"
										:pt="{ className: '!rounded-xl' }"
										@tap="requestPayment"
									>
										å‘èµ·æ”¯ä»˜è¯·æ±‚
									</cl-button>
								</view>
							</view>
						</view>
					</cl-collapse>
				</view>

				<!-- çœŸå®æ”¯ä»˜ -->
				<view class="section">
					<view
						class="section-header"
						@tap="collapseState.wxRealPay = !collapseState.wxRealPay"
					>
						<view class="section-title">
							<cl-icon
								name="money-cny-circle-line"
								:size="40"
								color="primary"
							></cl-icon>
							<cl-text size="lg" bold>å¾®ä¿¡çœŸå®æ”¯ä»˜æµ‹è¯•</cl-text>
						</view>
						<cl-icon
							name="arrow-down-s-line"
							:size="36"
							:pt="{
								className: parseClass([
									'text-surface-400 duration-200',
									{ '-rotate-180': collapseState.wxRealPay }
								])
							}"
						></cl-icon>
					</view>

					<cl-collapse v-model="collapseState.wxRealPay">
						<scroll-view scroll-y style="max-height: 500px">
							<view class="collapse-content">
								<!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
								<view class="progress-steps">
									<view
										class="progress-step"
										:class="{
											active: realPayState.step >= 1,
											done: realPayState.step > 1
										}"
									>
										<view class="step-dot">1</view>
										<cl-text size="xs">åˆ›å»ºè®¢å•</cl-text>
									</view>
									<view
										class="progress-line"
										:class="{ active: realPayState.step >= 2 }"
									></view>
									<view
										class="progress-step"
										:class="{ active: realPayState.step >= 2 }"
									>
										<view class="step-dot">2</view>
										<cl-text size="xs">å‘èµ·æ”¯ä»˜</cl-text>
									</view>
								</view>

								<!-- Step 1: é€‰æ‹©å¥—é¤ & åˆ›å»ºè®¢å• -->
								<view class="step-card">
									<view class="step-header">
										<view
											class="step-badge"
											:class="{ done: realPayState.step >= 2 }"
											>1</view
										>
										<cl-text bold>é€‰æ‹©å¥—é¤ & åˆ›å»ºè®¢å•</cl-text>
									</view>
									<view class="step-content">
										<!-- å¥—é¤é€‰æ‹© -->
										<view class="package-list">
											<view
												v-for="pkg in packageOptions"
												:key="pkg.id"
												class="package-item"
												:class="{ selected: selectedPackageId === pkg.id }"
												@tap="selectedPackageId = pkg.id"
											>
												<view class="package-radio">
													<view
														v-if="selectedPackageId === pkg.id"
														class="radio-inner"
													></view>
												</view>
												<view class="package-info">
													<cl-text size="sm" bold>{{ pkg.name }}</cl-text>
													<cl-text size="lg" color="error" bold
														>Â¥{{ pkg.price }}</cl-text
													>
												</view>
											</view>
										</view>

										<!-- å½“å‰è®¢å•å· -->
										<view v-if="realPayState.outTradeNo" class="info-box">
											<cl-text size="xs" color="info">è®¢å•å·:</cl-text>
											<cl-text size="xs">{{
												realPayState.outTradeNo
											}}</cl-text>
										</view>

										<cl-button
											type="primary"
											size="small"
											:loading="realPayState.loading"
											@tap="createRealOrder"
										>
											{{
												realPayState.outTradeNo
													? "é‡æ–°åˆ›å»ºè®¢å•"
													: "åˆ›å»ºè®¢å•"
											}}
										</cl-button>
									</view>
								</view>

								<!-- Step 2: å‘èµ·æ”¯ä»˜ -->
								<view
									class="step-card"
									:class="{ disabled: realPayState.step < 2 }"
								>
									<view class="step-header">
										<view class="step-badge">2</view>
										<cl-text bold>å‘èµ·æ”¯ä»˜</cl-text>
									</view>
									<view class="step-content">
										<view class="action-row">
											<cl-button
												type="primary"
												:disabled="realPayState.step < 2"
												:pt="{ className: 'flex-1' }"
												@tap="doRealPayment"
											>
												ç«‹å³æ”¯ä»˜
											</cl-button>
										</view>
									</view>
								</view>

								<!-- è¾…åŠ©æ“ä½œ -->
								<view class="step-card aux-card">
									<view class="step-header">
										<cl-icon
											name="tools-line"
											:size="32"
											color="info"
										></cl-icon>
										<cl-text bold>è¾…åŠ©æ“ä½œ</cl-text>
									</view>
									<view class="step-content">
										<view class="button-grid-3">
											<cl-button
												type="info"
												size="small"
												@tap="checkOrderStatus"
											>
												æŸ¥è¯¢è®¢å•
											</cl-button>
											<cl-button
												type="success"
												size="small"
												@tap="regenerateAndPay"
											>
												é‡æ–°æ”¯ä»˜
											</cl-button>
											<cl-button
												type="info"
												size="small"
												@tap="fetchOrderList"
											>
												è®¢å•åˆ—è¡¨
											</cl-button>
											<cl-button size="small" @tap="resetRealPayState">
												é‡ç½®çŠ¶æ€
											</cl-button>
										</view>
									</view>
								</view>

								<!-- è®¢å•åˆ—è¡¨ -->
								<view v-if="showOrderList" class="step-card">
									<view class="step-header">
										<cl-icon
											name="file-list-line"
											:size="32"
											color="primary"
										></cl-icon>
										<cl-text bold>è®¢å•åˆ—è¡¨</cl-text>
										<cl-text size="xs" color="info"
											>({{ orderList.length }}æ¡)</cl-text
										>
										<view style="flex: 1"></view>
										<cl-button
											size="small"
											type="info"
											@tap="showOrderList = false"
										>
											æ”¶èµ·
										</cl-button>
									</view>
									<view class="step-content">
										<view v-if="orderList.length === 0" class="empty-tip">
											<cl-text color="info" size="sm">æš‚æ— è®¢å•</cl-text>
										</view>
										<view v-else class="order-list">
											<view
												v-for="order in orderList"
												:key="order.outTradeNo"
												class="order-item"
											>
												<view class="order-row">
													<cl-text size="xs" color="info">è®¢å•å·</cl-text>
													<cl-text
														size="xs"
														:pt="{ className: 'break-all' }"
													>
														{{ order.outTradeNo }}
													</cl-text>
												</view>
												<view class="order-row">
													<cl-text size="xs" color="info">é‡‘é¢</cl-text>
													<cl-text size="sm" color="error" bold>
														Â¥{{ formatFee(order.totalFee) }}
													</cl-text>
												</view>
												<view class="order-row">
													<cl-text size="xs" color="info">çŠ¶æ€</cl-text>
													<cl-text
														size="xs"
														:color="
															order.status === 'SUCCESS'
																? 'success'
																: order.status === 'CLOSED'
																	? 'info'
																	: 'warn'
														"
													>
														{{ formatStatus(order.status) }}
													</cl-text>
												</view>
												<view class="order-row">
													<cl-text size="xs" color="info">æ—¶é—´</cl-text>
													<cl-text size="xs">
														{{ formatTime(order.createdAt) }}
													</cl-text>
												</view>
												<view
													class="order-row"
													v-if="order.status === 'PREPAY'"
												>
													<cl-button
														type="warn"
														size="small"
														@tap="closeCurrentOrder(order)"
													>
														å…³é—­è®¢å•
													</cl-button>
												</view>
											</view>
										</view>
									</view>
								</view>
							</view>
						</scroll-view>
					</cl-collapse>
				</view>

				<!-- æƒé™æµ‹è¯• -->
				<view class="section">
					<view
						class="section-header"
						@tap="collapseState.permission = !collapseState.permission"
					>
						<view class="section-title">
							<cl-icon name="shield-check-line" :size="40" color="success"></cl-icon>
							<cl-text size="lg" bold>æƒé™ç”³è¯·æµ‹è¯•</cl-text>
						</view>
						<cl-icon
							name="arrow-down-s-line"
							:size="36"
							:pt="{
								className: parseClass([
									'text-surface-400 duration-200',
									{ '-rotate-180': collapseState.permission }
								])
							}"
						></cl-icon>
					</view>

					<cl-collapse v-model="collapseState.permission">
						<view class="collapse-content">
							<view class="button-grid">
								<cl-button type="primary" @tap="testCameraPermission">
									ç›¸æœºæƒé™
								</cl-button>
								<cl-button type="success" @tap="testRecordPermission">
									å½•éŸ³æƒé™
								</cl-button>
								<cl-button type="warn" @tap="testLocationPermission">
									ä½ç½®æƒé™
								</cl-button>
								<cl-button type="info" @tap="testAlbumPermission">
									ç›¸å†Œæƒé™
								</cl-button>
								<cl-button type="info" @tap="testCustomPermission">
									è‡ªå®šä¹‰æƒé™
								</cl-button>
								<cl-button type="info" @tap="toTestPage"> å‰å¾€ WebView </cl-button>
							</view>

							<!-- ä½¿ç”¨è¯´æ˜ -->
							<view class="tips-box">
								<cl-text size="sm" bold color="info">ä½¿ç”¨è¯´æ˜</cl-text>
								<view class="tips-list">
									<cl-text size="xs" color="info"
										>1. ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¸åŒæƒé™ç”³è¯·</cl-text
									>
									<cl-text size="xs" color="info"
										>2. é¦–æ¬¡ç”³è¯·ä¼šå¼¹å‡ºè¯´æ˜å’Œæˆæƒæ¡†</cl-text
									>
									<cl-text size="xs" color="info"
										>3. å¦‚æœæ‹’ç»è¿‡ï¼Œä¼šå¼•å¯¼å»è®¾ç½®é¡µé¢</cl-text
									>
									<cl-text size="xs" color="info"
										>4. å·²æˆæƒçš„æƒé™ä¼šç›´æ¥è¿”å›æˆåŠŸ</cl-text
									>
								</view>
							</view>
						</view>
					</cl-collapse>
				</view>

				<!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
				<view class="section log-section">
					<view class="log-header">
						<view class="section-title">
							<cl-icon name="file-list-3-line" :size="40" color="info"></cl-icon>
							<cl-text size="lg" bold>æ‰§è¡Œæ—¥å¿—</cl-text>
						</view>
						<cl-button size="small" type="info" @tap="clearLog">æ¸…ç©º</cl-button>
					</view>
					<view class="log-container">
						<view v-if="testLog.length === 0" class="log-empty">
							<cl-icon name="inbox-line" :size="60" color="info"></cl-icon>
							<cl-text color="info" size="sm">æš‚æ— æ—¥å¿—ï¼Œå¼€å§‹æµ‹è¯•å§</cl-text>
						</view>
						<view v-for="(item, index) in testLog" :key="index" class="log-item">
							<cl-text
								size="xs"
								:color="
									item.includes('âœ…')
										? 'success'
										: item.includes('âŒ')
											? 'error'
											: 'white'
								"
								:pt="{ className: 'break-all' }"
							>
								{{ item }}
							</cl-text>
						</view>
					</view>
				</view>
			</view>
		</template>
	</app-page>
</template>

<style lang="scss" scoped>
.test-container {
	padding: 24rpx;
	min-height: 100vh;
	background: linear-gradient(180deg, #f8f9fc 0%, #f0f2f5 100%);
}

.section {
	background: white;
	border-radius: 24rpx;
	margin-bottom: 24rpx;
	box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.04);
	overflow: hidden;
}

.section-header {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
	padding: 28rpx 24rpx;
	background: white;
}

.section-title {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 16rpx;
}

.collapse-content {
	padding: 0 24rpx 24rpx;
}

// æ­¥éª¤å¡ç‰‡
.step-card {
	background: #f8f9fc;
	border-radius: 16rpx;
	padding: 20rpx;
	margin-bottom: 16rpx;

	&:last-child {
		margin-bottom: 0;
	}
}

.step-header {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 12rpx;
	margin-bottom: 16rpx;
}

.step-badge {
	width: 40rpx;
	height: 40rpx;
	border-radius: 50%;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	font-size: 24rpx;
	font-weight: bold;
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: center;
}

.step-content {
	padding-left: 52rpx;
}

// Code å±•ç¤ºåŒº
.code-display {
	margin-bottom: 16rpx;
}

.code-box {
	background: white;
	border: 2rpx solid #e8e8e8;
	border-radius: 12rpx;
	padding: 20rpx;
	min-height: 80rpx;
}

.action-row {
	display: flex;
	flex-direction: row;
	gap: 16rpx;
}

// JSON è§£æåŒºåŸŸ
.json-parse-area {
	margin-bottom: 20rpx;
}

.json-input-wrapper {
	position: relative;
	margin-top: 12rpx;
}

.json-textarea {
	width: 100%;
	height: 160rpx;
	background: white;
	border: 2rpx solid #e8e8e8;
	border-radius: 12rpx;
	padding: 16rpx;
	padding-right: 120rpx;
	font-size: 24rpx;
	color: #333;
	box-sizing: border-box;
}

.parse-btn {
	position: absolute;
	right: 12rpx;
	bottom: 12rpx;
}

// åˆ†éš”çº¿
.divider {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 20rpx;
	margin: 24rpx 0;
}

.divider-line {
	flex: 1;
	height: 2rpx;
	background: #e8e8e8;
}

// å‚æ•°åˆ—è¡¨
.param-list {
	display: flex;
	flex-direction: column;
	gap: 12rpx;
}

.param-item {
	display: flex;
	flex-direction: row;
	align-items: center;
	background: white;
	border: 2rpx solid #e8e8e8;
	border-radius: 12rpx;
	overflow: hidden;
}

.param-label {
	width: 180rpx;
	padding: 0 20rpx;
	color: #666;
	flex-shrink: 0;
}

.param-input {
	flex: 1;
	height: 80rpx;
	background: transparent;
}

// æŒ‰é’®ç½‘æ ¼
.button-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 16rpx;
	margin-bottom: 20rpx;
}

.button-grid-3 {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	gap: 12rpx;
}

// è¿›åº¦æŒ‡ç¤ºå™¨
.progress-steps {
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: center;
	padding: 20rpx 0;
	margin-bottom: 16rpx;
}

.progress-step {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 8rpx;
	opacity: 0.5;

	&.active {
		opacity: 1;
	}

	&.done .step-dot {
		background: #10b981;
	}
}

.step-dot {
	width: 48rpx;
	height: 48rpx;
	border-radius: 50%;
	background: #d1d5db;
	color: white;
	font-size: 24rpx;
	font-weight: bold;
	display: flex;
	align-items: center;
	justify-content: center;
}

.progress-step.active .step-dot {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.progress-line {
	width: 60rpx;
	height: 4rpx;
	background: #e5e7eb;
	margin: 0 8rpx;
	margin-bottom: 32rpx;

	&.active {
		background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
	}
}

// æ­¥éª¤å¡ç‰‡ç¦ç”¨çŠ¶æ€
.step-card.disabled {
	opacity: 0.6;
	pointer-events: none;
}

.step-badge.done {
	background: #10b981 !important;
}

// ä¿¡æ¯å±•ç¤ºæ¡†
.info-box {
	background: #f0f9ff;
	border: 2rpx solid #bae6fd;
	border-radius: 12rpx;
	padding: 16rpx;
	margin-bottom: 16rpx;
	display: flex;
	flex-direction: column;
	gap: 8rpx;
}

// å¥—é¤é€‰æ‹©
.package-list {
	display: flex;
	flex-direction: column;
	gap: 12rpx;
	margin-bottom: 16rpx;
}

.package-item {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 16rpx;
	background: white;
	border: 2rpx solid #e8e8e8;
	border-radius: 12rpx;
	padding: 16rpx 20rpx;
	transition: all 0.2s;

	&.selected {
		border-color: #667eea;
		background: #f5f3ff;
	}
}

.package-radio {
	width: 36rpx;
	height: 36rpx;
	border-radius: 50%;
	border: 4rpx solid #d1d5db;
	display: flex;
	align-items: center;
	justify-content: center;

	.package-item.selected & {
		border-color: #667eea;
	}
}

.radio-inner {
	width: 18rpx;
	height: 18rpx;
	border-radius: 50%;
	background: #667eea;
}

.package-info {
	flex: 1;
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
}

// è¾…åŠ©å¡ç‰‡
.aux-card {
	background: #fafafa;
	border: 2rpx dashed #e5e7eb;
}

// è®¢å•åˆ—è¡¨
.order-list {
	display: flex;
	flex-direction: column;
	gap: 16rpx;
}

.order-item {
	background: white;
	border: 2rpx solid #e8e8e8;
	border-radius: 12rpx;
	padding: 16rpx;
}

.order-row {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
	padding: 6rpx 0;
}

.empty-tip {
	padding: 40rpx;
	text-align: center;
}

// æç¤ºæ¡†
.tips-box {
	background: #f0f9ff;
	border-radius: 12rpx;
	padding: 16rpx;
	border: 2rpx solid #bae6fd;
}

.tips-list {
	display: flex;
	flex-direction: column;
	gap: 8rpx;
	margin-top: 12rpx;
}

// æ—¥å¿—åŒºåŸŸ
.log-section {
	.log-header {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 28rpx 24rpx;
	}
}

.log-container {
	background: #1a1a2e;
	border-radius: 0 0 24rpx 24rpx;
	padding: 20rpx;
	max-height: 500rpx;
	overflow-y: auto;
}

.log-empty {
	padding: 60rpx 0;
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 16rpx;
}

.log-item {
	padding: 12rpx 16rpx;
	border-bottom: 1rpx solid rgba(255, 255, 255, 0.1);

	&:last-child {
		border-bottom: none;
	}
}
</style>
